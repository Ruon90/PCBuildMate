{% extends "base.html" %}

{% load currency_tags %}
{% block content %}
<div class="container">
       <div class="row mb-3">
        <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mt-1">
                                <h2>Preview Build</h2>
                                <div class="col-6 mt-2">
                                    <p><strong>Total Price:</strong> {{ currency|currency_symbol }}{{ price|convert_from_usd:currency|floatformat:2 }}</p>
                                </div>
                                <div class="col-6 mt-2">
                                    <p class="mb-1 text-end"><strong>Total Performance:</strong> {{ total_perf_pct|default:"-"|floatformat:0 }}%</p>
                                    <div class="text-end small">
                                        <div>CPU performance: {{ cpu_perf|default:"-"|floatformat:0 }}%</div>
                                        <div>GPU performance: {{ gpu_perf|default:"-"|floatformat:0 }}%</div>
                                        <div>RAM performance: {{ ram_perf|default:"-"|floatformat:0 }}%</div>
                                    </div>
                                </div>
                            </div>
                            
                            
                            <div class="div mt-4">
                                <p class="d-flex gap-2">
                                    <a href="{% url 'preview_edit' %}" class="btn btn-primary">Edit preview</a>
                                    <a href="{% url 'alternatives' %}" class="btn btn-outline-secondary">Alternatives</a>
                                </p>
                            </div>
                            
                           
                        </div>
                    </div>
                
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                        <h4 class="card-title">Performance estimates</h4>
                        {% if mode == 'workstation' %}
                        {# For workstation mode show a single summary (no resolution toggles) #}
                        {% if workstation_render_time %}
                          <div class="mt-3">
                            <p class="mb-2"><strong>Blender BMW Render (seconds):</strong> {{ workstation_render_time }}</p>
                          </div>
                        {% endif %}
                        {% for res, data in perf_map.items %}
                            {% if res == default_resolution %}
                                <div class="mt-3">
                                    <p class="mb-2"><strong>Bottleneck:</strong> {{ data.bottleneck.type }} â€” {{ data.bottleneck.bottleneck }}%</p>
                                    <ul class="list-unstyled mb-1 mt-1">
                                        {% for label, sec in data.workstation.items %}
                                        <li><strong>{{ label }}</strong>: {{ sec }} seconds</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% else %}
                                                <!-- Resolution toggles like upgrade preview -->
                                                <div id="bp-perf">
                                                                                <div class="d-flex align-items-center mb-2">
                                                                                    <div><strong>Estimated FPS</strong></div>
                                                                                    <div class="btn-group ms-3" role="group" aria-label="Resolutions">
                                                                                        {% for res_entry in fps_res_list %}
                                                                                            <button type="button" class="btn btn-sm btn-outline-primary bp-res-toggle {% if res_entry.res == default_resolution or forloop.first %}active{% endif %}" data-res="{{ res_entry.res }}">{{ res_entry.res }}</button>
                                                                                        {% endfor %}
                                                                                    </div>
                                                                                </div>

                                                                                {% for res_entry in fps_res_list %}
                                                                                    <div class="bp-fps-pane" data-res-pane="{{ res_entry.res }}" style="display: {% if res_entry.res == default_resolution or forloop.first %}block{% else %}none{% endif %};">
                                                                                        <ul class="list-unstyled small">
                                                                                            {% for game, vals in res_entry.games.items %}
                                                                    <li>
                                                                        {{ game }}:
                                                                        {% if vals.overall %}
                                                                            {{ vals.overall }} FPS (CPU: {{ vals.cpu }}, GPU: {{ vals.gpu }})
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                                                        <p class="small text-muted">Bottleneck: {{ res_entry.bottleneck.type }} ({{ res_entry.bottleneck.bottleneck|floatformat:1 }}%)</p>
                                                        </div>
                                                                                {% endfor %}

                                                    <script>
                                                    document.addEventListener('DOMContentLoaded', function () {
                                                        const root = document.getElementById('bp-perf');
                                                        if (!root) return;
                                                        const buttons = root.querySelectorAll('.bp-res-toggle');
                                                        const panes = root.querySelectorAll('.bp-fps-pane');
                                                        buttons.forEach(btn => btn.addEventListener('click', function () {
                                                            const r = this.getAttribute('data-res');
                                                            buttons.forEach(b=>b.classList.remove('active'));
                                                            this.classList.add('active');
                                                            panes.forEach(p => {
                                                                p.style.display = (p.getAttribute('data-res-pane') === r) ? 'block' : 'none';
                                                            });
                                                        }));
                                                    });
                                                    </script>
                                                </div>
                        {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">CPU</div>
                <div class="card-body">
                    <h5>{{ cpu.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ cpu.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ cpu.userbenchmark_score }}</p>
                    <p>Blender: {{ cpu.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Graphics Card</div>
                <div class="card-body">
                    <h5>{{ gpu.gpu_name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ gpu.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ gpu.userbenchmark_score }}</p>
                    <p>Blender: {{ gpu.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Motherboard</div>
                <div class="card-body">
                    <h5>{{ motherboard.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ motherboard.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>Chipset: {{ motherboard.chipset }}</p>
                    <p>Blender: {{ motherboard.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">RAM</div>
                <div class="card-body">
                    <h5>{{ ram.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ ram.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ ram.userbenchmark_score }}</p>
                    <p>Blender: {{ ram.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Case</div>
                <div class="card-body">
                    <h5>{{ case.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ case.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ case.userbenchmark_score }}</p>
                    <p>Blender: {{ case.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Power Supply</div>
                <div class="card-body">
                    <h5>{{ psu.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ psu.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ psu.userbenchmark_score }}</p>
                    <p>Blender: {{ psu.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Storage</div>
                <div class="card-body">
                    <h5>{{ storage.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ storage.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ storage.userbenchmark_score }}</p>
                    <p>Blender: {{ storage.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">CPU Cooler</div>
                <div class="card-body">
                    <h5>{{ cooler.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ cooler.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ cooler.userbenchmark_score }}</p>
                    <p>Blender: {{ cooler.blender_score }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Case</div>
                <div class="card-body">
                    <h5>{{ case.name }}</h5>
                    <p>Price: {{ currency|currency_symbol }}{{ case.price|convert_from_usd:currency|floatformat:2 }}</p>
                    <p>UserBenchmark: {{ case.userbenchmark_score }}</p>
                    <p>Blender: {{ case.blender_score }}</p>
                </div>
            </div>
            
            
        </div>
        <!-- Repeat for GPU, RAM, Storage, PSU, Cooler, Case -->
    </div>

        <!-- Replacement modals removed in favor of unified Edit preview page -->
        <!-- Use the "Edit preview" button above to make changes to the preview build -->
 

{% if not is_saved_preview %}
    {% if user.is_authenticated %}
        <!-- Logged-in users: direct save -->
        <form method="post" action="{% url 'save_build' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Save build to account</button>
        </form>
    {% else %}
        <!-- Anonymous users: trigger signup modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#signupModal">
            Register to save this build
        </button>
    {% endif %}

    <form method="post" action="{% url 'clear_build' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger mt-3">
                    Clear Current Build
            </button>
    </form>
{% endif %}

</div>
{% endblock %}
