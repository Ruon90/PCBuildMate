{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Edit Build #{{ build.pk }}</h2>

  <!-- Toggle buttons -->
  <div class="btn-group mb-4" role="group">
    <button type="button" class="btn btn-primary" id="basicBtn">Basic</button>
    <button type="button" class="btn btn-outline-secondary" id="advancedBtn">Advanced</button>
  </div>

  <form method="post" action="{% url 'edit_build' build.pk %}">
    {% csrf_token %}
    <input type="hidden" name="mode" id="mode" value="basic">

    <!-- BASIC VIEW -->
    <div id="basicView">
      <div class="mb-3">
        <label for="budget" class="form-label">Budget (£)</label>
        <input type="number" name="budget" id="budget" class="form-control"
               value="{{ build.budget|default:1000 }}" required>
        <small class="text-muted">Adjust your budget and parts will be reassigned automatically.</small>
      </div>
    </div>

    <!-- ADVANCED VIEW -->
    <div id="advancedView" style="display:none;">

      <!-- Filter toggle groups -->
      <div class="mb-3">
        <label class="form-label">CPU brand</label>
        <div id="cpuBrandFilters" class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary" data-brand="amd">AMD</button>
          <button type="button" class="btn btn-outline-primary" data-brand="intel">Intel</button>
          <button type="button" class="btn btn-outline-secondary" id="cpuClear">Clear</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">GPU brand</label>
        <div id="gpuBrandFilters" class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary" data-brand="amd">AMD</button>
          <button type="button" class="btn btn-outline-primary" data-brand="intel">Intel</button>
          <button type="button" class="btn btn-outline-secondary" id="gpuClear">Clear</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">RAM DDR</label>
        <div id="ramDDRFilters" class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary" data-ddr="DDR3">DDR3</button>
          <button type="button" class="btn btn-outline-primary" data-ddr="DDR4">DDR4</button>
          <button type="button" class="btn btn-outline-primary" data-ddr="DDR5">DDR5</button>
          <button type="button" class="btn btn-outline-secondary" id="ramClear">Clear</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Storage interface</label>
        <div id="storageFilters" class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary" data-iface="pcie gen3">PCIe Gen3</button>
          <button type="button" class="btn btn-outline-primary" data-iface="pcie gen4">PCIe Gen4</button>
          <button type="button" class="btn btn-outline-primary" data-iface="pcie gen5">PCIe Gen5</button>
          <button type="button" class="btn btn-outline-secondary" id="storageClear">Clear</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">PSU minimum wattage</label>
        <div id="psuFilters" class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary" data-wattage="400">400W+</button>
          <button type="button" class="btn btn-outline-primary" data-wattage="600">600W+</button>
          <button type="button" class="btn btn-outline-primary" data-wattage="800">800W+</button>
          <button type="button" class="btn btn-outline-primary" data-wattage="1000">1000W+</button>
          <button type="button" class="btn btn-outline-secondary" id="psuClear">Clear</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Cooler throughput</label>
        <div id="coolerFilters" class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary" data-throughput="50">≥50W</button>
          <button type="button" class="btn btn-outline-primary" data-throughput="150">≥150W</button>
          <button type="button" class="btn btn-outline-primary" data-throughput="300">≥300W</button>
          <button type="button" class="btn btn-outline-secondary" id="coolerClear">Clear</button>
        </div>
      </div>

      <!-- Dropdowns -->
      {% include "calculator/edit_build_advanced.html" %}
    </div>

    <div class="mt-4 d-flex justify-content-between">
      <a href="{% url 'saved_builds' %}" class="btn btn-secondary">Cancel</a>
      <button type="submit" class="btn btn-success">Save Changes</button>
    </div>
  </form>
</div>

<!-- Toggle script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const basicBtn = document.getElementById("basicBtn");
  const advancedBtn = document.getElementById("advancedBtn");
  const basicView = document.getElementById("basicView");
  const advancedView = document.getElementById("advancedView");
  const modeField = document.getElementById("mode");

  basicBtn.addEventListener("click", () => {
    basicView.style.display = "block";
    advancedView.style.display = "none";
    modeField.value = "basic";
    basicBtn.classList.add("btn-primary");
    basicBtn.classList.remove("btn-outline-secondary");
    advancedBtn.classList.add("btn-outline-secondary");
    advancedBtn.classList.remove("btn-primary");
  });

  advancedBtn.addEventListener("click", () => {
    basicView.style.display = "none";
    advancedView.style.display = "block";
    modeField.value = "advanced";
    advancedBtn.classList.add("btn-primary");
    advancedBtn.classList.remove("btn-outline-secondary");
    basicBtn.classList.add("btn-outline-secondary");
    basicBtn.classList.remove("btn-primary");
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const cpuSelect = document.getElementById("cpu");
  const gpuSelect = document.getElementById("gpu");
  const ramSelect = document.getElementById("ram");
  const moboSelect = document.getElementById("motherboard");
  const caseSelect = document.getElementById("case");
  const psuSelect = document.getElementById("psu");
  const coolerSelect = document.getElementById("cooler");
  const storageSelect = document.getElementById("storage");

  const cpuClear = document.getElementById("cpuClear");
  const gpuClear = document.getElementById("gpuClear");
  const ramClear = document.getElementById("ramClear");
  const storageClear = document.getElementById("storageClear");
  const psuClear = document.getElementById("psuClear");
  const coolerClear = document.getElementById("coolerClear");

  function normalizeDDR(s){ return s ? s.toString().trim().toUpperCase() : ""; }
  function normalizeFF(s){
    if (!s) return "";
    const v = s.toLowerCase().replace(/\s|-/g,"");
    if (v.includes("miniitx")) return "mini-itx";
    if (v.includes("microatx")) return "microatx";
    if (v.includes("atx")) return "atx";
    if (v.includes("tower")) return "tower";
    return v;
  }
  function normalizeIface(s){
    if (!s) return "";
    const v = s.toLowerCase();
    if (v.includes("pcie") || v.includes("nvme")) {
      if (v.includes("gen5")) return "pcie gen5";
      if (v.includes("gen4")) return "pcie gen4";
      return "pcie gen3";
    }
    if (v.includes("sata")) return "sata";
    return v;
  }

  function showTooltip(id,msg){ const el=document.getElementById(id); if(el){ el.textContent=msg; el.style.display="block"; } }
  function markInvalid(sel){ sel.classList.add("is-invalid"); sel.setAttribute("aria-invalid","true"); }
  function clearInvalid(sel){ sel.classList.remove("is-invalid"); sel.removeAttribute("aria-invalid"); }
  function ensureSelection(select){
    const sel = select.selectedOptions[0];
    if (!sel || sel.hidden) {
      const firstVisible = [...select.options].find(o => !o.hidden);
      if (firstVisible) firstVisible.selected = true;
    }
  }
  function activate(groupId, btn){
    document.querySelectorAll(`#${groupId} button`).forEach(b=>{
      b.classList.remove("btn-primary");
      b.classList.add("btn-outline-primary");
    });
    btn.classList.remove("btn-outline-primary");
    btn.classList.add("btn-primary");
  }

  function filterMobosByCpu(showTip=false){
    const cpuSocket = cpuSelect.selectedOptions[0]?.dataset.socket || "";
    [...moboSelect.options].forEach(opt => { opt.hidden = (opt.dataset.socket !== cpuSocket); });
    const selHidden = moboSelect.selectedOptions[0]?.hidden;
    if (showTip && selHidden) { showTooltip("moboMessage", `CPU socket mismatch. Select a ${cpuSocket} motherboard.`); markInvalid(moboSelect); }
    if (!selHidden) clearInvalid(moboSelect);
  }

  function filterMobosByRam(showTip=false){
    const ramDDR = normalizeDDR(ramSelect.selectedOptions[0]?.dataset.ddr);
    [...moboSelect.options].forEach(opt => {
      const moboDDR = normalizeDDR(opt.dataset.ddr);
      opt.hidden = !(ramDDR === moboDDR || !ramDDR);
    });
    const selHidden = moboSelect.selectedOptions[0]?.hidden;
    if (showTip && selHidden) { showTooltip("ramMessage", `Motherboard does not support ${ramDDR}. Change motherboard or RAM.`); markInvalid(moboSelect); }
    if (!selHidden) clearInvalid(moboSelect);
  }

  function filterRamByMobo(showTip=false){
    const moboDDR = normalizeDDR(moboSelect.selectedOptions[0]?.dataset.ddr);
    [...ramSelect.options].forEach(opt => {
      const ramDDR = normalizeDDR(opt.dataset.ddr);
      opt.hidden = !(ramDDR === moboDDR || !moboDDR);
    });
    const selHidden = ramSelect.selectedOptions[0]?.hidden;
    if (showTip && selHidden) { showTooltip("moboMessage", `Use ${moboDDR} RAM for this motherboard.`); markInvalid(ramSelect); }
    if (!selHidden) clearInvalid(ramSelect);
  }

  function filterCases(showTip=false){
    const moboFF = normalizeFF(moboSelect.selectedOptions[0]?.dataset.formfactor);
    [...caseSelect.options].forEach(opt => {
      const caseFF = normalizeFF(opt.dataset.formfactor);
      let ok=false;
      if (moboFF==="mini-itx") ok = ["mini-itx","atx","tower"].includes(caseFF);
      else if (moboFF==="microatx") ok = caseFF!=="mini-itx";
      else if (moboFF==="atx") ok = ["atx","tower"].includes(caseFF);
      else ok = caseFF===moboFF;
      opt.hidden = !ok;
    });
    const selHidden = caseSelect.selectedOptions[0]?.hidden;
    if (showTip && selHidden) { showTooltip("caseMessage", `Case does not fit ${moboFF} motherboards.`); markInvalid(caseSelect); }
    if (!selHidden) clearInvalid(caseSelect);
  }

  function filterStorage(showTip=false){
    const moboNvme = (moboSelect.selectedOptions[0]?.dataset.nvme || "false").toLowerCase();
    [...storageSelect.options].forEach(opt => {
      const iface = normalizeIface(opt.dataset.interface);
      let ok = true;
      if (iface.startsWith("pcie")) ok = moboNvme === "true";
      opt.hidden = !ok;
    });
    const selHidden = storageSelect.selectedOptions[0]?.hidden;
    if (showTip && selHidden) { showTooltip("storageMessage", `Motherboard does not support NVMe/PCIe. Choose SATA or change motherboard.`); markInvalid(storageSelect); }
    if (!selHidden) clearInvalid(storageSelect);
  }

  function filterPSUs(showTip=false){
    const cpuTDP = parseInt(cpuSelect.selectedOptions[0]?.dataset.tdp || "0",10);
    const gpuTDP = parseInt(gpuSelect.selectedOptions[0]?.dataset.tdp || "0",10);
    const required = Math.round((cpuTDP + gpuTDP) * 1.3);
    [...psuSelect.options].forEach(opt => {
      const wattage = parseInt(opt.dataset.wattage || "0",10);
      opt.hidden = wattage < required;
    });
    const selHidden = psuSelect.selectedOptions[0]?.hidden;
    if (showTip && selHidden) { showTooltip("psuMessage", `PSU insufficient. Select ≥ ${required}W.`); markInvalid(psuSelect); }
    if (!selHidden) clearInvalid(psuSelect);
  }

  function filterCoolers(showTip=false){
    const cpuTDP = parseInt(cpuSelect.selectedOptions[0]?.dataset.tdp || "0",10);
    [...coolerSelect.options].forEach(opt => {
      const th = parseInt(opt.dataset.throughput || "0",10);
      opt.hidden = th < cpuTDP;
    });
    const selHidden = coolerSelect.selectedOptions[0]?.hidden;
    if (showTip && selHidden) { showTooltip("coolerMessage", `Cooler insufficient for CPU TDP (${cpuTDP}W).`); markInvalid(coolerSelect); }
    if (!selHidden) clearInvalid(coolerSelect);
  }

  // Button filters + highlight
  function clearFilter(groupId, select){
    document.querySelectorAll(`#${groupId} button`).forEach(b=>{
      b.classList.remove("btn-primary"); b.classList.add("btn-outline-primary");
    });
    [...select.options].forEach(opt => { opt.hidden = false; });
    ensureSelection(select);
  }

  document.querySelectorAll("#cpuBrandFilters button[data-brand]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const brand = btn.dataset.brand;
      [...cpuSelect.options].forEach(opt => { opt.hidden = (opt.dataset.brand !== brand); });
      activate("cpuBrandFilters", btn);
      showTooltip("cpuMessage", `Filtered CPUs: ${brand.toUpperCase()}.`);
      ensureSelection(cpuSelect);
      filterMobosByCpu(true);
    });
  });
  cpuClear?.addEventListener("click", ()=> clearFilter("cpuBrandFilters", cpuSelect));

  document.querySelectorAll("#gpuBrandFilters button[data-brand]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const brand = btn.dataset.brand;
      [...gpuSelect.options].forEach(opt => { opt.hidden = (opt.dataset.brand !== brand); });
      activate("gpuBrandFilters", btn);
      showTooltip("gpuMessage", `Filtered GPUs: ${brand.toUpperCase()}.`);
      ensureSelection(gpuSelect);
      filterPSUs(true);
    });
  });
  gpuClear?.addEventListener("click", ()=> clearFilter("gpuBrandFilters", gpuSelect));

  document.querySelectorAll("#ramDDRFilters button[data-ddr]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const ddr = btn.dataset.ddr;
      [...ramSelect.options].forEach(opt => { opt.hidden = normalizeDDR(opt.dataset.ddr) !== ddr; });
      activate("ramDDRFilters", btn);
      showTooltip("ramMessage", `Filtered RAM: ${ddr}.`);
      ensureSelection(ramSelect);
      filterMobosByRam(true);
      filterRamByMobo(true);
    });
  });
  ramClear?.addEventListener("click", ()=> clearFilter("ramDDRFilters", ramSelect));

  document.querySelectorAll("#storageFilters button[data-iface]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const iface = btn.dataset.iface.toLowerCase();
      [...storageSelect.options].forEach(opt => {
        const norm = normalizeIface(opt.dataset.interface);
        opt.hidden = !norm.includes(iface);
      });
      activate("storageFilters", btn);
      showTooltip("storageMessage", `Filtered Storage: ${iface.toUpperCase()}.`);
      ensureSelection(storageSelect);
      filterStorage(true);
    });
  });
  storageClear?.addEventListener("click", ()=> clearFilter("storageFilters", storageSelect));

  document.querySelectorAll("#psuFilters button[data-wattage]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const minW = parseInt(btn.dataset.wattage,10);
      [...psuSelect.options].forEach(opt => {
        const w = parseInt(opt.dataset.wattage || "0",10);
        opt.hidden = w < minW;
      });
      activate("psuFilters", btn);
      showTooltip("psuMessage", `Filtered PSUs: ≥${minW}W.`);
      ensureSelection(psuSelect);
      filterPSUs(true);
    });
  });
  psuClear?.addEventListener("click", ()=> clearFilter("psuFilters", psuSelect));

  document.querySelectorAll("#coolerFilters button[data-throughput]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const minT = parseInt(btn.dataset.throughput,10);
      [...coolerSelect.options].forEach(opt => {
        const th = parseInt(opt.dataset.throughput || "0",10);
        opt.hidden = th < minT;
      });
      activate("coolerFilters", btn);
      showTooltip("coolerMessage", `Filtered Coolers: ≥${minT}W.`);
      ensureSelection(coolerSelect);
      filterCoolers(true);
    });
  });
  coolerClear?.addEventListener("click", ()=> clearFilter("coolerFilters", coolerSelect));

  // Initial pass: run filters but only show tooltips if current selection is invalid
  filterMobosByCpu(true);
  filterMobosByRam(true);
  filterRamByMobo(true);
  filterCases(true);
  filterStorage(true);
  filterPSUs(true);
  filterCoolers(true);

  // Change events to re-check compatibility and tooltips
  cpuSelect.addEventListener("change", ()=>{ filterMobosByCpu(true); filterPSUs(true); filterCoolers(true); });
  gpuSelect.addEventListener("change", ()=>{ filterPSUs(true); });
  ramSelect.addEventListener("change", ()=>{ filterMobosByRam(true); filterRamByMobo(true); });
  moboSelect.addEventListener("change", ()=>{ filterRamByMobo(true); filterCases(true); filterStorage(true); });

});
</script>

<script>
  // Paste the consolidated script we built here
</script>
{% endblock %}
