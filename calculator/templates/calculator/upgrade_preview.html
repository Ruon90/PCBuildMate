{% extends "base.html" %}
{% load currency_tags %}
{% block content %}
<div class="container">
  <div class="row mb-3">
    <div class="col-md-12">
      <h2>Upgrade Preview</h2>
      <p class="text-muted">This page shows the components that will change if you apply the selected upgrade. You can save the upgrade snapshot to your account.</p>
      <div class="row">
        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-header">Current build</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <ul class="list-group">
                    <li class="list-group-item"><strong>CPU:</strong> {{ current_build.display.cpu }}</li>
                    <li class="list-group-item"><strong>GPU:</strong> {{ current_build.display.gpu }}</li>
                    <li class="list-group-item"><strong>Motherboard:</strong> {{ current_build.display.motherboard }}</li>
                    <li class="list-group-item"><strong>RAM:</strong> {{ current_build.display.ram }}</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <ul class="list-group">
                    <li class="list-group-item"><strong>Storage:</strong> {{ current_build.display.storage }}</li>
                    <li class="list-group-item"><strong>PSU:</strong> {{ current_build.display.psu }}</li>
                    <li class="list-group-item"><strong>Cooler:</strong> {{ current_build.display.cooler }}</li>
                    <li class="list-group-item"><strong>Case:</strong> {{ current_build.display.case }}</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-header">Suggested build</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <ul class="list-group">
                    <li class="list-group-item"><strong>CPU:</strong> {{ estimated_build.display.cpu }}</li>
                    <li class="list-group-item"><strong>GPU:</strong> {{ estimated_build.display.gpu }}</li>
                    <li class="list-group-item"><strong>Motherboard:</strong> {{ estimated_build.display.motherboard }}</li>
                    <li class="list-group-item"><strong>RAM:</strong> {{ estimated_build.display.ram }}</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <ul class="list-group">
                    <li class="list-group-item"><strong>Storage:</strong> {{ estimated_build.display.storage }}</li>
                    <li class="list-group-item"><strong>PSU:</strong> {{ estimated_build.display.psu }}</li>
                    <li class="list-group-item"><strong>Cooler:</strong> {{ estimated_build.display.cooler }}</li>
                    <li class="list-group-item"><strong>Case:</strong> {{ estimated_build.display.case }}</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card mb-3">
        <div class="card-body">
          <p><strong>Estimated gain:</strong> {{ percent|floatformat:2 }}%</p>
          <div class="d-flex align-items-center mb-2">
            <div><strong>Resolution</strong></div>
            <div class="btn-group ms-3" role="group" aria-label="Resolutions">
              {% for res_entry in fps_res_list %}
                <button type="button" class="btn btn-sm btn-outline-primary res-toggle {% if res_entry.res == default_resolution %}active{% endif %}" data-res="{{ res_entry.res }}">{{ res_entry.res }}</button>
              {% endfor %}
            </div>
          </div>

          {% for res_entry in fps_compare_list %}
            <div class="fps-compare-pane" data-res-pane="{{ res_entry.res }}" style="display: {% if res_entry.res == default_resolution %}block{% else %}none{% endif %};">
              <div class="row">
                <div class="col-6">
                  <div class="mb-2"><strong>Current Estimated FPS</strong></div>
                  <ul class="list-unstyled small">
                    {% for game, vals in res_entry.games.items %}
                      <li>{{ game }}: {% if vals.current %}{{ vals.current }} FPS{% else %}N/A{% endif %}</li>
                    {% endfor %}
                  </ul>
                  <p class="small text-muted">Bottleneck: {{ res_entry.bottleneck_current.type }} ({{ res_entry.bottleneck_current.bottleneck|floatformat:1 }}%)</p>
                </div>
                <div class="col-6">
                  <div class="mb-2"><strong>Estimated FPS</strong></div>
                  <ul class="list-unstyled small">
                    {% for game, vals in res_entry.games.items %}
                      <li>
                        {{ game }}:
                        {% if vals.estimated %}
                          {{ vals.estimated }} FPS
                          {% if vals.delta %}
                            <span class="ms-2 {% if vals.delta > 0 %}text-success{% elif vals.delta < 0 %}text-danger{% endif %}">
                              {% if vals.delta > 0 %}+{% endif %}{{ vals.delta }}
                            </span>
                          {% endif %}
                        {% else %}N/A{% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                  <p class="small text-muted">Bottleneck: {{ res_entry.bottleneck_estimated.type }} ({{ res_entry.bottleneck_estimated.bottleneck|floatformat:1 }}%)</p>
                </div>
              </div>
            </div>
          {% endfor %}

          {% if fps_compare_list|length == 0 %}
            <div class="alert alert-info mt-2 mb-0 small">
              No FPS comparison available for this proposal. Try generating upgrade proposals first, then open this preview.
            </div>
          {% endif %}

            <script>
            document.addEventListener('DOMContentLoaded', function () {
              const buttons = document.querySelectorAll('.res-toggle');
              const panesCmp = document.querySelectorAll('.fps-compare-pane');
              buttons.forEach(btn => btn.addEventListener('click', function () {
                const r = this.getAttribute('data-res');
                buttons.forEach(b=>b.classList.remove('active'));
                this.classList.add('active');
                panesCmp.forEach(p => {
                  p.style.display = (p.getAttribute('data-res-pane') === r) ? 'block' : 'none';
                });
              }));
            });
            </script>
          <p class="mt-2"><strong>Price delta:</strong> ${{ price_delta|floatformat:2 }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Primary components row: CPU, GPU, RAM -->
  <div class="row">
    <!-- CPU card -->
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header">CPU</div>
        <div class="card-body">
          {% with obj=estimated_build.cpu %}
          <h5>
            {% if obj.name %}{{ obj.name }}{% else %}{{ obj }}{% endif %}
          </h5>
          <ul class="list-unstyled mb-2 small">
            {% if obj.core_count %}<li><strong>Cores / Threads:</strong> {{ obj.core_count }}{% if obj.thread_count %} / {{ obj.thread_count }}{% endif %}</li>{% endif %}
            {% if obj.base_clock %}<li><strong>Base clock:</strong> {{ obj.base_clock }} GHz</li>{% endif %}
            {% if obj.boost_clock %}<li><strong>Boost clock:</strong> {{ obj.boost_clock }} GHz</li>{% endif %}
          </ul>
          <p class="mb-1"><strong>Performance:</strong> {% if cpu_perf %}{{ cpu_perf|floatformat:0 }}%{% else %}N/A{% endif %}</p>
          <p class="mb-1"><strong>Improvement:</strong> {% if cpu_percent is not None %}{{ cpu_percent|floatformat:2 }}%{% else %}N/A{% endif %}</p>
          <p class="mb-1"><strong>Price:</strong> {% if obj.price %}{{ currency|currency_symbol }}{{ obj.price|convert_from_usd:currency|floatformat:2 }}{% else %}N/A{% endif %}</p>
          <div class="mt-2 d-flex justify-content-end gap-2">
            <a href="#" class="component-action component-details" data-type="cpu" data-id="{{ obj.id }}" title="Further information"><i class="fa-solid fa-circle-info"></i></a>
            <a href="#" class="component-action component-youtube" data-query="{% if obj.name %}{{ obj.name }}{% else %}{{ obj }}{% endif %}" title="YouTube reviews"><i class="fa-brands fa-youtube"></i></a>
            <a href="https://www.amazon.com/s?k={% if obj.name %}{{ obj.name|urlencode }}{% else %}{{ obj|urlencode }}{% endif %}" target="_blank" rel="noopener" class="component-action" title="Search on Amazon"><i class="fa-brands fa-amazon"></i></a>
          </div>
          {% endwith %}
        </div>
      </div>
    </div>

    <!-- GPU card -->
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header">GPU</div>
        <div class="card-body">
          {% with obj=estimated_build.gpu %}
          <h5>
            {% if obj.gpu_name %}{{ obj.gpu_name }}{% elif obj.model %}{{ obj.model }}{% elif obj.name %}{{ obj.name }}{% else %}{{ obj }}{% endif %}
          </h5>
          <ul class="list-unstyled mb-2 small">
            {% if obj.vram %}<li><strong>VRAM:</strong> {{ obj.vram }} GB</li>{% endif %}
            {% if obj.base_clock %}<li><strong>Base clock:</strong> {{ obj.base_clock }} MHz</li>{% endif %}
            {% if obj.boost_clock %}<li><strong>Boost clock:</strong> {{ obj.boost_clock }} MHz</li>{% endif %}
          </ul>
          <p class="mb-1"><strong>Performance:</strong> {% if gpu_perf %}{{ gpu_perf|floatformat:0 }}%{% else %}N/A{% endif %}</p>
          <p class="mb-1"><strong>Improvement:</strong> {% if gpu_percent is not None %}{{ gpu_percent|floatformat:2 }}%{% else %}N/A{% endif %}</p>
          <p class="mb-1"><strong>Price:</strong> {% if obj.price %}{{ currency|currency_symbol }}{{ obj.price|convert_from_usd:currency|floatformat:2 }}{% else %}N/A{% endif %}</p>
          <div class="mt-2 d-flex justify-content-end gap-2">
            <a href="#" class="component-action component-details" data-type="gpu" data-id="{{ obj.id }}" title="Further information"><i class="fa-solid fa-circle-info"></i></a>
            <a href="#" class="component-action component-youtube" data-query="{% if obj.gpu_name %}{{ obj.gpu_name }}{% elif obj.model %}{{ obj.model }}{% elif obj.name %}{{ obj.name }}{% else %}{{ obj }}{% endif %}" title="YouTube reviews"><i class="fa-brands fa-youtube"></i></a>
            <a href="https://www.amazon.com/s?k={% if obj.gpu_name %}{{ obj.gpu_name|urlencode }}{% elif obj.model %}{{ obj.model|urlencode }}{% elif obj.name %}{{ obj.name|urlencode }}{% else %}{{ obj|urlencode }}{% endif %}" target="_blank" rel="noopener" class="component-action" title="Search on Amazon"><i class="fa-brands fa-amazon"></i></a>
          </div>
          {% endwith %}
        </div>
      </div>
    </div>

    <!-- RAM card -->
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header">RAM</div>
        <div class="card-body">
          {% with obj=estimated_build.ram %}
          <h5>
            {% if obj.name %}{{ obj.name }}{% elif obj.model %}{{ obj.model }}{% else %}{{ obj }}{% endif %}
          </h5>
          <ul class="list-unstyled mb-2 small">
            {% if obj.ddr_generation %}<li><strong>DDR Generation:</strong> {{ obj.ddr_generation }}</li>{% elif obj.ddr_version %}<li><strong>DDR:</strong> {{ obj.ddr_version }}</li>{% endif %}
            {% if obj.frequency_mhz %}<li><strong>Frequency:</strong> {{ obj.frequency_mhz }} MHz</li>{% elif obj.speed %}<li><strong>Speed:</strong> {{ obj.speed }} MHz</li>{% endif %}
          </ul>
          <p class="mb-1"><strong>Performance:</strong> {% if ram_perf %}{{ ram_perf|floatformat:0 }}%{% else %}N/A{% endif %}</p>
          <p class="mb-1"><strong>Improvement:</strong> {% if ram_percent is not None %}{{ ram_percent|floatformat:2 }}%{% else %}N/A{% endif %}</p>
          <p class="mb-1"><strong>Price:</strong> {% if obj.price %}{{ currency|currency_symbol }}{{ obj.price|convert_from_usd:currency|floatformat:2 }}{% else %}N/A{% endif %}</p>
          <div class="mt-2 d-flex justify-content-end gap-2">
            <a href="#" class="component-action component-details" data-type="ram" data-id="{{ obj.id }}" title="Further information"><i class="fa-solid fa-circle-info"></i></a>
            <a href="#" class="component-action component-youtube" data-query="{% if obj.name %}{{ obj.name }}{% elif obj.model %}{{ obj.model }}{% else %}{{ obj }}{% endif %}" title="YouTube reviews"><i class="fa-brands fa-youtube"></i></a>
            <a href="https://www.amazon.com/s?k={% if obj.name %}{{ obj.name|urlencode }}{% elif obj.model %}{{ obj.model|urlencode }}{% else %}{{ obj|urlencode }}{% endif %}" target="_blank" rel="noopener" class="component-action" title="Search on Amazon"><i class="fa-brands fa-amazon"></i></a>
          </div>
          {% endwith %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    {# Second row: all other changed parts #}
    {% for part, data in changed_items.items %}
      {% if part != 'cpu' and part != 'gpu' and part != 'ram' %}
      {% with obj=data.obj percent=data.percent %}
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-header">{{ part|title }}</div>
          <div class="card-body">
            <h5>
              {% if part == 'psu' %}
                {% if obj.brand %}{{ obj.brand }} {% endif %}{{ obj.name }}{% if obj.wattage %} {{ obj.wattage }}W{% endif %}
              {% else %}
                {% if obj.name %}{{ obj.name }}{% elif obj.gpu_name %}{{ obj.gpu_name }}{% else %}{{ obj }}{% endif %}
              {% endif %}
            </h5>
            <ul class="list-unstyled mb-2 small">
              {% if part == 'motherboard' %}
                {% if obj.socket %}<li><strong>Socket:</strong> {{ obj.socket }}</li>{% endif %}
                {% if obj.form_factor %}<li><strong>Form Factor:</strong> {{ obj.form_factor }}</li>{% endif %}
                {% if obj.ddr_version %}<li><strong>DDR Version:</strong> {{ obj.ddr_version }}</li>{% endif %}
                {% if obj.nvme_support %}<li><strong>NVMe:</strong> {{ obj.nvme_support }}</li>{% endif %}
                {% with obj.bios_update_required|default_if_none:'' as biosreq %}{% if biosreq != '' %}<li><strong>BIOS update:</strong> {{ biosreq|yesno:"Yes,No" }}</li>{% endif %}{% endwith %}
              {% endif %}

              {% if part == 'case' %}
                {% if obj.case_type %}<li><strong>Case type:</strong> {{ obj.case_type }}</li>{% endif %}
                {% if obj.color %}<li><strong>Color:</strong> {{ obj.color }}</li>{% endif %}
                {% if obj.psu %}<li><strong>PSU:</strong> {{ obj.psu }}</li>{% endif %}
              {% endif %}

              {% if part == 'psu' %}
                {% if obj.psu_type %}<li><strong>PSU type:</strong> {{ obj.psu_type }}</li>{% endif %}
                {% if obj.efficiency %}<li><strong>Efficiency:</strong> {{ obj.efficiency }}</li>{% endif %}
                {% if obj.wattage %}<li><strong>Wattage:</strong> {{ obj.wattage }}W</li>{% endif %}
                {% if obj.modular %}<li><strong>Modular:</strong> {{ obj.modular }}</li>{% endif %}
              {% endif %}

              {% if part == 'storage' %}
                {% if obj.capacity %}<li><strong>Capacity:</strong> {{ obj.capacity }} GB</li>{% endif %}
                {% if obj.form_factor %}<li><strong>Form factor:</strong> {{ obj.form_factor }}</li>{% endif %}
                {% if obj.interface %}<li><strong>Interface:</strong> {{ obj.interface }}</li>{% endif %}
              {% endif %}

              {% if part == 'cooler' %}
                {% if obj.noise_level %}<li><strong>Noise level:</strong> {{ obj.noise_level }}</li>{% endif %}
                {% with obj.liquid|default_if_none:'' as liquidval %}{% if liquidval != '' %}<li><strong>Liquid:</strong> {{ liquidval|yesno:"Yes,No" }}</li>{% endif %}{% endwith %}
              {% endif %}
            </ul>
            <p class="mb-1"><strong>Price:</strong> {% if obj.price %}{{ currency|currency_symbol }}{{ obj.price|convert_from_usd:currency|floatformat:2 }}{% else %}N/A{% endif %}</p>
            <div class="mt-2 d-flex justify-content-end gap-2">
              <a href="#" class="component-action component-details" data-type="{{ part }}" data-id="{{ obj.id }}" title="Further information"><i class="fa-solid fa-circle-info"></i></a>
              <a href="#" class="component-action component-youtube" data-query="{% if obj.name %}{{ obj.name }}{% elif obj.gpu_name %}{{ obj.gpu_name }}{% elif obj.model %}{{ obj.model }}{% else %}{{ obj }}{% endif %}" title="YouTube reviews"><i class="fa-brands fa-youtube"></i></a>
              {% if part == 'psu' %}
              <a href="https://www.amazon.com/s?k={{ obj.brand|urlencode }}+{{ obj.name|urlencode }}+{{ obj.wattage }}W" target="_blank" rel="noopener" class="component-action" title="Search on Amazon"><i class="fa-brands fa-amazon"></i></a>
              {% else %}
              <a href="https://www.amazon.com/s?k={% if obj.name %}{{ obj.name|urlencode }}{% elif obj.gpu_name %}{{ obj.gpu_name|urlencode }}{% elif obj.model %}{{ obj.model|urlencode }}{% else %}{{ obj|urlencode }}{% endif %}" target="_blank" rel="noopener" class="component-action" title="Search on Amazon"><i class="fa-brands fa-amazon"></i></a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endwith %}
      {% endif %}
    {% endfor %}
  </div>

  {% if user.is_authenticated %}
    <form method="post" action="{% url 'save_build' %}">
      {% csrf_token %}
      <input type="hidden" name="is_upgrade" value="1">
      <input type="hidden" name="upgrade_index" value="{{ proposal_index }}">
  <button type="submit" class="btn btn-outline-success">Save upgrade to account</button>
      <a href="{% url 'saved_builds' %}" class="btn btn-outline-secondary ms-2">Back to builds</a>
    </form>
  {% else %}
    <p class="mt-3">Register to save upgrades to your account.</p>
  {% endif %}

</div>
{% endblock %}
