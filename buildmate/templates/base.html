{% load static %}
{% load socialaccount %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PCBuildMate</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="d-flex flex-column min-vh-100">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'home' %}"><img src="{% static 'images/PCBM-header.png' %}" alt="PCBuildMate"></a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
        {% if request.session.preview_build %}
        <li class="nav-item"><a class="nav-link" href="{% url 'build_preview' %}">Build Calculator</a></li>
        {% endif %}
        <li class="nav-item"><a class="nav-link" href="{% url 'saved_builds' %}">Saved Builds</a></li>
        <li class="nav-item">
          <div class="d-flex">
            {% if user.is_authenticated %}
              <form method="post" action="{% url 'account_logout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger">Sign out</button>
              </form>
            {% else %}
              <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#authModal">
                Register / Login
              </button>
            {% endif %}
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
{% if messages %}
  <div id="flashMessages" class="container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
      {% endfor %}
    </div>
  {% endif %}
<main class="flex-grow-1 container my-5">
  {% block content %}{% endblock %}
  
</main>
<footer class="bg-dark text-white text-center py-3 mt-auto">
  <p>&copy; 2025 PCBuildMate. All rights reserved.</p>
</footer>
<!-- Ai Agent -->
<div id="ai-agent" style="
  position:fixed;
  bottom:20px;
  right:20px;
  width:320px;
  border:1px solid #ccc;
  border-radius:8px;
  background:#fff;
  box-shadow:0 0 10px rgba(0,0,0,0.2);
  font-family:Arial,sans-serif;
  z-index:9999;
  overflow:hidden;
">
  <!-- Header with close button -->
<div id="chat-header" style="
  background:#0078d7;
  color:#fff;
  padding:10px;
  font-weight:bold;
  text-align:center;
  cursor:pointer;
  position:relative;
">
  ðŸ’» PC Build Assistant
  <span id="chat-close" style="
    position:absolute;
    right:10px;
    top:5px;
    cursor:pointer;
    font-weight:bold;
    display:none; /* hidden by default */
  ">âœ•</span>
</div>

  <!-- Chat body (collapsed by default) -->
  <div id="chat-body" style="
    max-height:0;
    transition:max-height 0.4s ease;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  ">
    <div id="chat-window" style="
      flex:1;
      overflow-y:auto;
      padding:10px;
      font-size:14px;
      white-space:pre-line;
      min-height:300px;
    "></div>
    <input id="chat-input" type="text" placeholder="Ask about PC builds..." style="
      border:none;
      border-top:1px solid #ccc;
      padding:10px;
      font-size:14px;
      outline:none;
    "/>
  </div>

<!-- Auth Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Register / Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="d-grid gap-2 mb-3">
          <a href="{% url 'account_signup' %}" class="btn btn-primary w-100">Sign up</a>
          <a href="{% url 'account_login' %}" class="btn btn-secondary w-100">Log in</a>
          <a href="{% provider_login_url 'google' %}" class="btn btn-danger w-100">Sign in with Google</a>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Only auto-dismiss global flash messages rendered in the page header.
    const alerts = document.querySelectorAll('#flashMessages .alert');
    alerts.forEach(alert => {
      setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }, 4000); // auto-dismiss after 4 seconds
    });
  });
</script>
<script>
const chatHeader = document.getElementById("chat-header");
const chatBody = document.getElementById("chat-body");
const chatWindow = document.getElementById("chat-window");
const chatInput = document.getElementById("chat-input");
const chatClose = document.getElementById("chat-close");

let hasOpened = false;

// Toggle open/close with smooth animation
chatHeader.addEventListener("click", (e) => {
  if (e.target.id === "chat-close") return; // ignore clicks on X

  if (chatBody.style.maxHeight === "0px" || chatBody.style.maxHeight === "") {
    chatBody.style.maxHeight = "400px"; // expand
    chatClose.style.display = "block";  // show X
    if (!hasOpened) {
      chatWindow.innerHTML += "<p><b>AI:</b> Welcome! ðŸ‘‹<br>Ask me anything about PC builds and compatibility.</p>";
      hasOpened = true;
    }
  } else {
    chatBody.style.maxHeight = "0"; // collapse
    chatClose.style.display = "none"; // hide X
  }
});

// Close button
chatClose.addEventListener("click", () => {
  chatBody.style.maxHeight = "0";
  chatClose.style.display = "none"; // hide X when closed
});

// Thinking feedback
function showThinking() {
  const thinking = document.createElement("p");
  thinking.id = "thinking";
  thinking.innerHTML = "<i>AI is thinking...</i>";
  chatWindow.appendChild(thinking);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function hideThinking() {
  const thinking = document.getElementById("thinking");
  if (thinking) thinking.remove();
}

// Chat input handler
chatInput.addEventListener("keypress", function(e){
  if(e.key === "Enter"){
    const msg = e.target.value.trim();
    if(!msg) return;
    e.target.value = "";

    chatWindow.innerHTML += `<p><b>You:</b> ${msg}</p>`;
    showThinking();

    fetch("/ai-chat/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({message: msg})
    })
    .then(res => res.json())
    .then(data => {
      hideThinking();
      chatWindow.innerHTML += `<p><b>AI:</b><br>${data.reply}</p>`;
      if(data.videos){
        chatWindow.innerHTML += "<p><b>Here are some related YouTube videos:</b></p>";
        data.videos.slice(0,4).forEach(v => {
          chatWindow.innerHTML += `<p><a href="${v.url}" target="_blank">${v.title}</a></p>`;
        });
      }
      chatWindow.scrollTop = chatWindow.scrollHeight;
    })
    .catch(err => {
      hideThinking();
      chatWindow.innerHTML += `<p><b>AI:</b> Sorry, something went wrong.</p>`;
    });
  }
});
</script>
</body>
</html>
